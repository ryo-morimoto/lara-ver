# Development Guidelines

このドキュメントは、プロジェクトの開発方針とテスト戦略を記載しています。

## アーキテクチャ方針

### レイヤー構造
```
src/
├── shared/        # 共通定数
├── schemas/       # Zodスキーマ定義
├── core/          # ビジネスロジック
├── services/      # アプリケーションサービス
└── entrypoints/   # エントリーポイント
```

### 依存関係の方向
- `schemas` と `core` は `shared` の定数を参照
- `services` は `schemas` と `core` を使用
- `entrypoints` は `services` を使用

## テスト戦略

### TDD原則
- コードを生成する際は、対応するユニットテストを常に生成する
- コード修正後は `pnpm test` が必ずパスすることを確認する

## 開発ワークフロー

### 型とテスト駆動開発
1. **型定義から始める**: インターフェースや型を最初に定義
2. **テストを先に書く**: 実装前にテストケースを作成（Red）
3. **実装を書く**: テストをパスする最小限の実装（Green）
4. **品質チェック**:
   - `pnpm lint:fix` でコードスタイルを修正
   - `pnpm test` ですべてのテストがパスすることを確認
5. **リファクタリング**: 必要に応じてコードを改善（Refactor）

### 実装時のチェックリスト
- [ ] 型定義を作成した
- [ ] テストコードを書いた
- [ ] 実装コードを書いた
- [ ] `pnpm lint:fix` を実行した
- [ ] `pnpm test` がパスした
- [ ] 必要に応じてリファクタリングした

### 各レイヤーのテスト方針

#### 1. shared/ - テスト不要
- 単純な定数定義のみ
- 値の正当性はTypeScriptの型システムで保証

#### 2. schemas/ - テスト不要
- Zodの基本機能（boolean、string、enum等）のみ使用する場合はテスト不要
- カスタムバリデーション（`.refine()`等）を追加した場合のみテスト作成
- 型推論のテストは不要（TypeScriptが保証）

#### 3. core/ - テスト必須
- すべてのビジネスロジックに対してユニットテスト作成
- URL解析、バージョン比較、リダイレクトURL生成等

#### 4. services/ - テスト必須
- 統合ロジックのテスト
- スキーマバリデーションの実際の動作確認
- Chrome APIとの統合部分（モック使用）

#### 5. entrypoints/ - E2Eテストで対応
- ユニットテストは基本的に不要
- 必要に応じてE2Eテストやマニュアルテストで確認

## スキーマファースト開発

1. Zodスキーマを単一の真実の源（Single Source of Truth）として定義
2. TypeScript型は `z.infer<typeof schema>` で自動導出
3. 重複した型定義は作成しない

## その他の方針

- 過度な抽象化を避け、シンプルな設計を心がける
- WXTの規約に従う（自動インポート機能の活用等）
- パフォーマンスを重視（特にcontent script）
